---
title: Arthas之各模块简介
layout: info
commentable: true
date: 2020-08-02
mathjax: true
mermaid: true
tags: [Java,Java诊断,Arthas]
categories: [Java,Arthas]
description: Arthas之各模块简介。

---

### Arthas

#### 项目代码

[GitHub Code by arthas](https://github.com/alibaba/arthas)

#### 包含模块

![1596679506644](/images/2020/08/1596679506644.png)

### 模块简介

-	arthas-agent：基于JavaAgent技术的代理
-	bin：一些启动脚本
-	arthas-boot：Java版本的一键安装启动脚本
-	arthas-client：telnet client代码
-	arthas-common：一些共用的工具类和枚举类
-	arthas-core：核心库，各种arthas命令的交互和实现
-	arthas-demo：示例代码
-	arthas-memorycompiler：内存编绎器代码
-	arthas-packaging：maven打包相关的
-	arthas-site：arthas站点
-	arthas-spy：编织到目标类中的各个切面
-	static：静态资源
-	arthas-testcase：测试

### 主要功能

Arthas 提供的功能主要可以分为以下三个方面：

1. 信息监控
   - 进程运行基本信息包括：内存、CPU占用、线程信息、线程堆栈、线程数统计、环境变量信息。
   - 对象信息：类对象静态属性、 Mbean 的属性信息、已加载类信息、类加载器、类方法信息。
2. 方法调用
   - 方法调用入参、返回值查看。
   - 方法被调用的调用路径、调用耗时、方法调用次数、成功次数、失败次数等统计。
   - 记录和重做方法调用。
3. 类文件处理
   - dump 已加载类的字节码、字节码反编译、类编译、类重新热加载。

### 模块关系

模块关系说明：

1. arthas-boot.jar和as.sh模块功能类似，分别使用java和shell脚本，下载对应的jar包，并生成服务端和客户端的启动命令，然后启动客户端和服务端。
2. arthas-core.jar是服务端程序的启动入口类，会调用`virtualMachine#attach`到目标进程，并加载arthas-agent.jar作为agent jar包。
3. arthas-agent.jar既可以使用premain方式（在目标进程启动之前，通过-agent参数静态指定），也可以通过agentmain方式（在进程启动之后attach上去）。arthas-agent会使用自定义的classloader(`ArthasClassLoader`)加载arthas-core.jar里面的`com.taobao.arthas.core.config.Configure`类以及`com.taobao.arthas.core.server.ArthasBootstrap`。 同时程序运行的时候会使用arthas-spy.jar。
4. arthas-spy.jar里面只包含Spy类，目的是为了将Spy类使用`BootstrapClassLoader`来加载，从而使目标进程的java应用可以访问Spy类。通过ASM修改字节码，可以将Spy类的方法`ON_BEFORE_METHOD`， `ON_RETURN_METHOD`等编织到目标类里面。Spy类你可以简单理解为类似spring aop的Advice，有前置方法，后置方法等。
5. arthas-client.jar是客户端程序，用来连接arthas-core.jar启动的服务端代码，使用telnet方式。一般由arthas-boot.jar和as.sh来负责启动。

整体宏观模块调用图：

![1596698216827](/images/2020/08/1596698216827.png)

模块描述：

![1596616373228](/images/2020/08/1596616373228.png)

### 核心类描述

核心类描述：

![1596710846489](/images/2020/08/1596710846489.png)

核心类描述（精简版）

![1596700025625](/images/2020/08/1596700025625.png)

### 常用命令汇总

[Arthas 常用命令汇总](https://github.com/alibaba/arthas/issues/1003)

![1596701687793](/images/2020/08/1596701687793.png)